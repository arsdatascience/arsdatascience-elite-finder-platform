{% extends 'base.html' %}

{% block title %}Editar Agente Jurídico{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="card bg-dark text-white mb-4">
                <div class="card-header bg-info">
                    <h4 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>Configurações Técnicas do Agente
                        <button type="submit" form="editarEspecialistaForm" class="btn btn-sm btn-outline-light float-end">
                            <i class="fas fa-save me-1"></i>Salvar
                        </button>
                    </h4>
                </div>
                <div class="card-body">
                    <form id="editarEspecialistaForm" method="POST" action="{{ url_for('especialistas.editar', agente_id=especialista.id) }}">
                        <!-- ID do Agente -->
                        <div class="row mb-3">
                            <div class="col-12">
                                <small class="text-muted">ID: {{ especialista.id if especialista else '1' }}</small>
                            </div>
                        </div>

                        <!-- Informações Básicas -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label text-info">Nome do Agente</label>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" 
                                           name="nome" value="{{ especialista.nome if especialista else 'Especialista em Direito Penal' }}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-info">Categoria Jurídica</label>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" 
                                           name="categoria" value="{{ especialista.categoria if especialista else 'juridico' }}" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-info">Descrição do Agente</label>
                                    <textarea class="form-control bg-dark text-white border-secondary" rows="3" 
                                              name="descricao">{{ especialista.descricao if especialista else 'Especialista em análises jurídicas do direito agrário brasileiro' }}</textarea>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label text-info">Classe do Agente</label>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" 
                                           value="AgentePadrao" readonly>
                                    <small class="text-muted">Campo somente leitura</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label text-info">Nível de Especialização</label>
                                    <select class="form-select bg-dark text-white border-secondary" name="nivel_especializacao">
                                        <option value="1" {% if especialista and especialista.nivel_especializacao == 1 %}selected{% endif %}>1 - Iniciante</option>
                                        <option value="2" {% if especialista and especialista.nivel_especializacao == 2 %}selected{% endif %}>2 - Intermediário</option>
                                        <option value="3" {% if especialista and especialista.nivel_especializacao == 3 %}selected{% endif %}>3 - Avançado</option>
                                        <option value="4" {% if especialista and especialista.nivel_especializacao == 4 %}selected{% endif %}>4 - Especialista</option>
                                        <option value="5" {% if especialista and especialista.nivel_especializacao == 5 %}selected{% endif %}>5 - Expert</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Configurações de IA -->
                        <div class="card bg-dark border-info mb-4">
                            <div class="card-header bg-info">
                                <h6 class="mb-0 text-white">
                                    <i class="fas fa-robot me-2"></i>Configurações de IA
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label text-info">Provedor de IA</label>
                                            <select class="form-select bg-dark text-white border-secondary" name="provedor" id="provedorSelect" onchange="atualizarModelos()">
                                                <option value="openai" {% if especialista and especialista.provedor == 'openai' %}selected{% endif %}>OpenAI</option>
                                                <option value="anthropic" {% if especialista and especialista.provedor == 'anthropic' %}selected{% endif %}>Anthropic</option>
                                                <option value="google" {% if especialista and especialista.provedor == 'google' %}selected{% endif %}>Google AI</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label text-info">Modelo de IA</label>
                                            <select class="form-select bg-dark text-white border-secondary" name="modelo" id="modeloSelect">
                                                <!-- Opções serão carregadas dinamicamente -->
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label class="form-label text-info">Status do Agente</label>
                                            <div class="form-check form-switch mt-2">
                                                <input class="form-check-input" type="checkbox" name="ativo" 
                                                       {% if not especialista or especialista.ativo %}checked{% endif %}>
                                                <label class="form-check-label text-white">Ativo</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Parâmetros Técnicos -->
                        <div class="card bg-dark border-info mb-4">
                            <div class="card-header bg-info">
                                <h6 class="mb-0 text-white">
                                    <i class="fas fa-sliders-h me-2"></i>Parâmetros Técnicos
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label text-info">Temperatura</label>
                                            <input type="range" class="form-range" min="0" max="2" step="0.1" 
                                                   value="{{ especialista.temperatura if especialista else '0.7' }}" 
                                                   name="temperatura" id="temperatura">
                                            <div class="text-center">
                                                <small class="text-muted">0.7</small><br>
                                                <small class="text-muted">0-2: Controla criatividade</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label text-info">Top-P</label>
                                            <input type="range" class="form-range" min="0" max="1" step="0.05" 
                                                   value="0.95" name="top_p" id="top_p">
                                            <div class="text-center">
                                                <small class="text-muted">0.95</small><br>
                                                <small class="text-muted">0-1: Controla diversidade</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label text-info">Top-K</label>
                                            <input type="number" class="form-control bg-dark text-white border-secondary" 
                                                   value="10" name="top_k" min="1" max="100">
                                            <small class="text-muted">1-100: Filtra tokens</small>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="mb-3">
                                            <label class="form-label text-info">Max Tokens</label>
                                            <input type="number" class="form-control bg-dark text-white border-secondary" 
                                                   value="{{ especialista.max_tokens if especialista else '2000' }}" 
                                                   name="max_tokens" min="100" max="8000">
                                            <small class="text-muted">100-8000: Limite de resposta</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-info">Timeout</label>
                                            <input type="number" class="form-control bg-dark text-white border-secondary" 
                                                   value="60" name="timeout" min="10" max="300">
                                            <small class="text-muted">10-300: Tempo limite</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-info">Tentativas de retry</label>
                                            <input type="number" class="form-control bg-dark text-white border-secondary" 
                                                   value="3" name="tentativas" min="1" max="10">
                                            <small class="text-muted">1-10: Tentativas de retry</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Processamento Vetorial Avançado -->
                        <div class="card bg-dark border-success mb-4">
                            <div class="card-header bg-success">
                                <h6 class="mb-0 text-white">
                                    <i class="fas fa-brain me-2"></i>Processamento Vetorial Avançado
                                    <span class="badge bg-light text-success ms-2">NOVO</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <!-- Abas de Configuração -->
                                <ul class="nav nav-tabs nav-dark mb-3" id="processamentoTab" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active bg-dark text-info border-info" id="chunking-tab" data-bs-toggle="tab" data-bs-target="#chunking" type="button" role="tab">
                                            <i class="fas fa-cut me-1"></i>Chunking Inteligente
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link bg-dark text-info border-info" id="qualidade-tab" data-bs-toggle="tab" data-bs-target="#qualidade" type="button" role="tab">
                                            <i class="fas fa-star me-1"></i>Qualidade & Relevância
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link bg-dark text-info border-info" id="finetuning-tab" data-bs-toggle="tab" data-bs-target="#finetuning" type="button" role="tab">
                                            <i class="fas fa-question-circle me-1"></i>Auto Fine-Tuning
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link bg-dark text-info border-info" id="embeddings-tab" data-bs-toggle="tab" data-bs-target="#embeddings" type="button" role="tab">
                                            <i class="fas fa-vector-square me-1"></i>Embeddings Híbridos
                                        </button>
                                    </li>
                                </ul>

                                <div class="tab-content" id="processamentoTabContent">
                                    <!-- Aba 1: Chunking Inteligente -->
                                    <div class="tab-pane fade show active" id="chunking" role="tabpanel">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Modo de Fragmentação</label>
                                                    <select class="form-select bg-dark text-white border-secondary" name="modo_fragmentacao_avancado">
                                                        <option value="semantico" selected>Semântico (Recomendado)</option>
                                                        <option value="hierarquico">Hierárquico</option>
                                                        <option value="hibrido">Híbrido</option>
                                                        <option value="basico">Básico (Compatibilidade)</option>
                                                    </select>
                                                    <small class="text-muted">Detecta estrutura jurídica automaticamente</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Tamanho Ótimo (palavras)</label>
                                                    <input type="range" class="form-range" min="200" max="400" step="25" 
                                                           value="275" name="tamanho_chunk_palavras" id="tamanhoChunk">
                                                    <div class="text-center">
                                                        <small class="text-muted" id="tamanhoChunkValue">275 palavras</small><br>
                                                        <small class="text-muted">Ótimo para embeddings</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Sensibilidade à Estrutura</label>
                                                    <input type="range" class="form-range" min="1" max="10" step="1" 
                                                           value="7" name="sensibilidade_estrutura" id="sensibilidadeEstrutura">
                                                    <div class="text-center">
                                                        <small class="text-muted" id="sensibilidadeValue">7/10</small><br>
                                                        <small class="text-muted">Detecção de títulos, artigos</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Elementos Hierárquicos</label>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="detectar_titulos" checked>
                                                        <label class="form-check-label text-white">Títulos e Capítulos</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="detectar_artigos" checked>
                                                        <label class="form-check-label text-white">Artigos e Parágrafos</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="detectar_incisos" checked>
                                                        <label class="form-check-label text-white">Incisos e Alíneas</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Quebras Inteligentes</label>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="preservar_contexto" checked>
                                                        <label class="form-check-label text-white">Preservar Contexto Semântico</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="evitar_quebras_meio" checked>
                                                        <label class="form-check-label text-white">Não quebrar artigos no meio</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="agrupar_relacionados" checked>
                                                        <label class="form-check-label text-white">Agrupar temas relacionados</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Aba 2: Qualidade & Relevância -->
                                    <div class="tab-pane fade" id="qualidade" role="tabpanel">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Score Mínimo de Relevância</label>
                                                    <select class="form-select bg-dark text-white border-secondary" name="score_minimo_relevancia">
                                                        <option value="0.70">0.70 - Aceitar a maioria</option>
                                                        <option value="0.75">0.75 - Filtro básico</option>
                                                        <option value="0.80" selected>0.80 - Qualidade média</option>
                                                        <option value="0.85">0.85 - Alta relevância</option>
                                                        <option value="0.90">0.90 - Apenas excelente</option>
                                                    </select>
                                                    <small class="text-muted">Filtrar chunks por relevância</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Peso Conceitos Jurídicos</label>
                                                    <input type="range" class="form-range" min="0" max="100" step="10" 
                                                           value="70" name="peso_conceitos" id="pesoConceitos">
                                                    <div class="text-center">
                                                        <small class="text-muted" id="pesoConceitosValue">70%</small><br>
                                                        <small class="text-muted">vs texto geral</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Densidade Informacional</label>
                                                    <input type="range" class="form-range" min="1" max="10" step="1" 
                                                           value="6" name="densidade_informacional" id="densidadeInfo">
                                                    <div class="text-center">
                                                        <small class="text-muted" id="densidadeValue">6/10</small><br>
                                                        <small class="text-muted">Complexidade mínima</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Conceitos Jurídicos Prioritários</label>
                                                    <textarea class="form-control bg-dark text-white border-secondary" rows="3" 
                                                              name="conceitos_prioritarios" placeholder="propriedade, posse, usucapião, reforma agrária, função social, latifúndio, assentamento">{{ especialista.conceitos_prioritarios if especialista else 'propriedade, posse, usucapião, reforma agrária, função social, latifúndio, assentamento' }}</textarea>
                                                    <small class="text-muted">Separados por vírgula - específicos da área de expertise</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="detectar_definicoes" checked>
                                                    <label class="form-check-label text-white">Priorizar definições legais</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="detectar_obrigacoes" checked>
                                                    <label class="form-check-label text-white">Identificar obrigações e deveres</label>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="detectar_prazos" checked>
                                                    <label class="form-check-label text-white">Capturar prazos e valores</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="detectar_procedimentos" checked>
                                                    <label class="form-check-label text-white">Mapear procedimentos</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Aba 3: Auto Fine-Tuning -->
                                    <div class="tab-pane fade" id="finetuning" role="tabpanel">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Tipos de Perguntas</label>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="gerar_perguntas_basicas" checked>
                                                        <label class="form-check-label text-white">Básicas (definições)</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="gerar_perguntas_intermediarias" checked>
                                                        <label class="form-check-label text-white">Intermediárias (relações)</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="gerar_perguntas_avancadas" checked>
                                                        <label class="form-check-label text-white">Avançadas (aplicação)</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="gerar_perguntas_especializadas" checked>
                                                        <label class="form-check-label text-white">Especializadas (técnicas)</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Frequência de Perguntas</label>
                                                    <select class="form-select bg-dark text-white border-secondary" name="perguntas_por_chunk">
                                                        <option value="2">2 perguntas por chunk</option>
                                                        <option value="3">3 perguntas por chunk</option>
                                                        <option value="4" selected>4 perguntas por chunk</option>
                                                        <option value="5">5 perguntas por chunk</option>
                                                        <option value="6">6 perguntas por chunk</option>
                                                    </select>
                                                    <small class="text-muted">Balancear qualidade vs quantidade</small>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Validação de Cobertura</label>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="validar_cobertura_temas" checked>
                                                        <label class="form-check-label text-white">Verificar cobertura temática</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="gerar_pergunta_complementar">
                                                        <label class="form-check-label text-white">Pergunta complementar se necessário</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Template de Perguntas Personalizadas</label>
                                                    <textarea class="form-control bg-dark text-white border-secondary" rows="4" 
                                                              name="template_perguntas" placeholder="Básica: O que significa {conceito} no contexto de direito agrário?
Intermediária: Como {conceito1} se relaciona com {conceito2}?
Avançada: Qual a aplicação prática de {conceito} em propriedades rurais?
Especializada: Quais as implicações de {conceito} em casos de {area_especialidade}?"></textarea>
                                                    <small class="text-muted">Use {conceito}, {area_especialidade} para substituições automáticas</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Aba 4: Embeddings Híbridos -->
                                    <div class="tab-pane fade" id="embeddings" role="tabpanel">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Modelo de Embedding</label>
                                                    <select class="form-select bg-dark text-white border-secondary" name="modelo_embedding">
                                                        <option value="text-embedding-3-small" selected>text-embedding-3-small (Rápido)</option>
                                                        <option value="text-embedding-3-large">text-embedding-3-large (Preciso)</option>
                                                        <option value="text-embedding-ada-002">text-embedding-ada-002 (Compatibilidade)</option>
                                                    </select>
                                                    <small class="text-muted">Balance entre velocidade e precisão</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Peso do Contexto</label>
                                                    <input type="range" class="form-range" min="0" max="50" step="5" 
                                                           value="25" name="peso_contexto" id="pesoContexto">
                                                    <div class="text-center">
                                                        <small class="text-muted" id="pesoContextoValue">25%</small><br>
                                                        <small class="text-muted">Influência título/seção</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Cache Inteligente</label>
                                                    <div class="form-check form-switch">
                                                        <input class="form-check-input" type="checkbox" name="cache_embeddings" checked>
                                                        <label class="form-check-label text-white">Reutilizar embeddings similares</label>
                                                    </div>
                                                    <small class="text-muted">Economiza tokens da API</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Informações Contextuais</label>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="incluir_titulo" checked>
                                                        <label class="form-check-label text-white">Incluir título do documento</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="incluir_tipo_secao" checked>
                                                        <label class="form-check-label text-white">Incluir tipo de seção</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="incluir_hierarquia" checked>
                                                        <label class="form-check-label text-white">Incluir nível hierárquico</label>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label class="form-label text-success">Otimizações</label>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="normalizar_embeddings">
                                                        <label class="form-check-label text-white">Normalizar vetores</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="reduzir_dimensionalidade">
                                                        <label class="form-check-label text-white">Redução dimensional (PCA)</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" name="embedding_batch" checked>
                                                        <label class="form-check-label text-white">Processamento em lotes</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Integração AI Assistant & Base Vetorial -->
                        <div class="card bg-dark border-success mb-4">
                            <div class="card-header bg-success">
                                <h6 class="mb-0 text-white">
                                    <i class="fas fa-rocket me-2"></i>Integração AI Assistant & Base Vetorial
                                    <span class="badge bg-light text-success ms-2">POTENCIALIZAÇÃO</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-success">Conectar com AI Assistant</label>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" name="usar_ai_assistant" checked>
                                                <label class="form-check-label text-white">Usar biblioteca de prompts especializada</label>
                                            </div>
                                            <small class="text-muted">Acessa prompts jurídicos pré-configurados do sistema</small>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label text-success">Base Vetorial Ativa</label>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" name="usar_base_vetorial" checked>
                                                <label class="form-check-label text-white">Busca semântica em documentos</label>
                                            </div>
                                            <small class="text-muted">Conecta com base de documentos jurídicos processados</small>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label text-success">Processamento Inteligente</label>
                                            <div class="form-check form-switch">
                                                <input class="form-check-input" type="checkbox" name="processamento_contextual" checked>
                                                <label class="form-check-label text-white">Análise contextual avançada</label>
                                            </div>
                                            <small class="text-muted">Considera contexto da consulta para resultados mais precisos</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-success">Filtros de Especialização</label>
                                            <select class="form-select bg-dark text-white border-secondary" name="filtro_area_juridica" multiple id="filtrosEspecializacao">
                                                <!-- Opções serão carregadas dinamicamente baseadas na área do especialista -->
                                            </select>
                                            <small class="text-muted">Filtros específicos da área de expertise do agente</small>
                                            <div class="mt-2">
                                                <button type="button" class="btn btn-outline-success btn-sm" onclick="carregarFiltrosEspecializacao()">
                                                    <i class="fas fa-sync me-1"></i>Atualizar Filtros
                                                </button>
                                                <small class="text-success ms-2" id="statusFiltros">Filtros serão carregados automaticamente</small>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label text-success">Documentos de Contexto</label>
                                            <input type="range" class="form-range" min="3" max="15" step="1" 
                                                   value="8" name="chunks_contexto" id="chunksContexto">
                                            <div class="text-center">
                                                <small class="text-muted" id="chunksContextoValue">8 documentos</small><br>
                                                <small class="text-muted">Contexto adicional por resposta</small>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label text-success">Threshold de Relevância</label>
                                            <input type="range" class="form-range" min="0.6" max="0.95" step="0.05" 
                                                   value="0.8" name="threshold_relevancia" id="thresholdRelevancia">
                                            <div class="text-center">
                                                <small class="text-muted" id="thresholdValue">0.80</small><br>
                                                <small class="text-muted">Mínimo de similitude para incluir documento</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sistema de Prompts Avançado -->
                        <div class="card bg-dark border-warning mb-4">
                            <div class="card-header bg-warning">
                                <h6 class="mb-0 text-dark">
                                    <i class="fas fa-brain me-2"></i>Sistema de Prompts Avançado
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label class="form-label text-warning">System Prompt (Personalidade Principal)</label>
                                            <textarea class="form-control bg-dark text-white border-secondary" rows="10" 
                                                      name="system_prompt">{{ especialista.system_prompt if especialista else '# Especialista em Direito Penal\n\nVocê é um especialista em Direito Penal com profundo conhecimento em direito criminal, processo penal e legislação penal. Sempre consulte a base vetorial de documentos jurídicos para fundamentar suas respostas com precedentes e legislação específica. Seja preciso, prático e cite sempre as fontes legais.' }}</textarea>
                                            <small class="text-muted">Define a personalidade completa e comportamento detalhado do agente (baseado nos arquivos de prompt fornecidos)</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-warning">Prompt de Busca Vetorial</label>
                                            <textarea class="form-control bg-dark text-white border-secondary" rows="3" 
                                                      name="prompt_busca_vetorial">Antes de responder, consulte a base vetorial usando a consulta: "{query_usuario} direito agrário {area_especialidade}" e identifique os documentos mais relevantes.</textarea>
                                            <small class="text-muted">Como realizar buscas na base vetorial</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-warning">Prompt de Análise</label>
                                            <textarea class="form-control bg-dark text-white border-secondary" rows="3" 
                                                      name="prompt_analise">Analise os documentos encontrados e identifique: 1) Artigos de lei relevantes, 2) Precedentes jurisprudenciais, 3) Implicações práticas para o caso.</textarea>
                                            <small class="text-muted">Como analisar documentos recuperados</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <div class="mb-3">
                                            <label class="form-label text-warning">Prompt de Resposta Estruturada</label>
                                            <textarea class="form-control bg-dark text-white border-secondary" rows="4" 
                                                      name="prompt_resposta">Estruture sua resposta da seguinte forma:
1. **RESPOSTA DIRETA**: Responda objetivamente à pergunta
2. **BASE LEGAL**: Cite artigos de lei e normas aplicáveis  
3. **PRECEDENTES**: Mencione jurisprudência relevante se houver
4. **APLICAÇÃO PRÁTICA**: Como isso se aplica na prática
5. **RECOMENDAÇÕES**: Sugestões específicas para o caso</textarea>
                                            <small class="text-muted">Estrutura da resposta final apresentada ao usuário</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-warning">Prompt para Casos Complexos</label>
                                            <textarea class="form-control bg-dark text-white border-secondary" rows="3" 
                                                      name="prompt_casos_complexos">Para questões complexas, realize múltiplas buscas com termos relacionados e sintetize as informações de diferentes fontes antes de responder.</textarea>
                                            <small class="text-muted">Estratégia para questões que requerem análise aprofundada</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label class="form-label text-warning">Prompt de Validação</label>
                                            <textarea class="form-control bg-dark text-white border-secondary" rows="3" 
                                                      name="prompt_validacao">Sempre valide suas respostas verificando se há informações conflitantes na base vetorial e indique quando há divergências jurisprudenciais.</textarea>
                                            <small class="text-muted">Como validar e verificar a consistência das respostas</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Assistente IA - Preenchimento Automático -->
                        <div class="card bg-dark border-info mb-4">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-magic me-2"></i>Assistente IA - Configuração Automática
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label text-info">Descreva o especialista que você quer criar</label>
                                    <textarea class="form-control bg-dark text-white border-secondary" rows="4" 
                                              name="descricao_agente" placeholder="Ex: Um especialista em contratos de arrendamento rural que domina a legislação agrária, conhece os modelos de contratos mais utilizados no agronegócio e pode orientar sobre cláusulas específicas para diferentes tipos de propriedades rurais.

Inclua: área de especialização, tipos de documentos que deve conhecer, legislação específica.">{{ especialista.instrucoes_especiais if especialista and especialista.instrucoes_especiais else '' }}</textarea>
                                    <small class="text-muted">Baseado nesta descrição, o sistema configurará automaticamente prompts, filtros e parâmetros otimizados</small>
                                </div>
                                <button type="button" class="btn btn-info" id="btnPreencherAuto">
                                    <i class="fas fa-magic me-2"></i>Configurar Automaticamente
                                </button>
                                <small class="text-muted d-block mt-2">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    O assistente analisará sua descrição e preencherá automaticamente os campos de prompts, filtros e configurações vetoriais
                                </small>
                            </div>
                        </div>

                        <!-- Capacidades de princípio -->
                        <div class="card bg-dark border-info mb-4">
                            <div class="card-header bg-info d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-white">
                                    <i class="fas fa-list-check me-2"></i>Capacidades de princípio
                                </h6>
                                <button type="button" class="btn btn-sm btn-outline-light" onclick="adicionarCapacidade()">
                                    <i class="fas fa-plus me-1"></i>Adicionar
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="capacidades-container">
                                    {% if especialista and especialista.capacidades %}
                                        {% for capacidade in especialista.capacidades %}
                                        <div class="input-group mb-2 capacidade-item">
                                            <input type="text" class="form-control bg-dark text-white border-secondary" 
                                                   name="capacidades" value="{{ capacidade }}" placeholder="Descrição da capacidade">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removerCapacidade(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <div class="input-group mb-2 capacidade-item">
                                            <input type="text" class="form-control bg-dark text-white border-secondary" 
                                                   name="capacidades" value="Análise de documentos jurídicos" placeholder="Descrição da capacidade">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removerCapacidade(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div class="input-group mb-2 capacidade-item">
                                            <input type="text" class="form-control bg-dark text-white border-secondary" 
                                                   name="capacidades" value="Geração de pareceres técnicos" placeholder="Descrição da capacidade">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removerCapacidade(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                        <div class="input-group mb-2 capacidade-item">
                                            <input type="text" class="form-control bg-dark text-white border-secondary" 
                                                   name="capacidades" value="Pesquisa jurisprudencial avançada" placeholder="Descrição da capacidade">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removerCapacidade(this)">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Use o botão "Adicionar" para incluir novas capacidades ou clique no ícone de lixeira para remover capacidades existentes.
                                    </small>
                                </div>
                            </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Custom dark theme styles */
.bg-dark {
    background-color: #2c3e50 !important;
}

.form-control.bg-dark {
    background-color: #34495e !important;
    border-color: #5a6c7d !important;
    color: #ecf0f1 !important;
}

.form-control.bg-dark:focus {
    background-color: #34495e !important;
    border-color: #3498db !important;
    box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25) !important;
    color: #ecf0f1 !important;
}

.form-select.bg-dark {
    background-color: #34495e !important;
    border-color: #5a6c7d !important;
    color: #ecf0f1 !important;
}

.form-range {
    accent-color: #3498db;
}

.card.bg-dark {
    background-color: #2c3e50 !important;
    border-color: #34495e !important;
}

.border-info {
    border-color: #17a2b8 !important;
}

.border-warning {
    border-color: #ffc107 !important;
}

.text-info {
    color: #17a2b8 !important;
}

.text-warning {
    color: #ffc107 !important;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Atualizar valores dos ranges
    const temperatura = document.getElementById('temperatura');
    const topP = document.getElementById('top_p');
    
    if (temperatura) {
        temperatura.addEventListener('input', function() {
            this.nextElementSibling.querySelector('small').textContent = this.value;
        });
    }
    
    if (topP) {
        topP.addEventListener('input', function() {
            this.nextElementSibling.querySelector('small').textContent = this.value;
        });
    }
    
    // Preenchimento automático (placeholder)
    const btnPreencherAuto = document.getElementById('btnPreencherAuto');
    if (btnPreencherAuto) {
        btnPreencherAuto.addEventListener('click', function() {
            alert('Funcionalidade de preenchimento automático será implementada em breve.');
        });
    }
});

// Funções para gerenciar capacidades
function adicionarCapacidade() {
    const container = document.getElementById('capacidades-container');
    const novaCapacidade = document.createElement('div');
    novaCapacidade.className = 'input-group mb-2 capacidade-item';
    novaCapacidade.innerHTML = `
        <input type="text" class="form-control bg-dark text-white border-secondary" 
               name="capacidades" placeholder="Descrição da capacidade">
        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removerCapacidade(this)">
            <i class="fas fa-trash"></i>
        </button>
    `;
    container.appendChild(novaCapacidade);
    
    // Foco no novo campo
    novaCapacidade.querySelector('input').focus();
}

function removerCapacidade(botao) {
    const container = document.getElementById('capacidades-container');
    const capacidadeItem = botao.closest('.capacidade-item');
    
    // Não permitir remover se for a última capacidade
    if (container.children.length > 1) {
        capacidadeItem.remove();
    } else {
        alert('Pelo menos uma capacidade deve ser mantida.');
    }
}

// Configuração dos modelos por provedor
const modelosPorProvedor = {
    'openai': [
        { value: 'gpt-4o', text: 'GPT-4o (Melhor Modelo)' },
        { value: 'gpt-4o-mini', text: 'GPT-4o mini (Custo-Efetivo)' },
        { value: 'gpt-4-turbo', text: 'GPT-4 Turbo' },
        { value: 'gpt-4', text: 'GPT-4' },
        { value: 'gpt-3.5-turbo', text: 'GPT-3.5 Turbo' }
    ],
    'anthropic': [
        { value: 'claude-sonnet-4-20250514', text: 'Claude 4 Sonnet (Melhor Modelo)' },
        { value: 'claude-3-5-haiku-20241022', text: 'Claude 4 Haiku (Rápido)' },
        { value: 'claude-3-opus-20240229', text: 'Claude 3 Opus' },
        { value: 'claude-3-sonnet-20240229', text: 'Claude 3 Sonnet (Equilibrado)' }
    ],
    'google': [
        { value: 'gemini-1.5-pro', text: 'Gemini 1.5 Pro (Melhor Modelo)' },
        { value: 'gemini-1.5-flash', text: 'Gemini 1.5 Flash (Econômico)' },
        { value: 'gemini-pro', text: 'Gemini Pro' }
    ]
};

// Função para atualizar modelos baseado no provedor
function atualizarModelos() {
    const provedorSelect = document.getElementById('provedorSelect');
    const modeloSelect = document.getElementById('modeloSelect');
    const provedor = provedorSelect.value;
    
    // Limpar opções existentes
    modeloSelect.innerHTML = '';
    
    // Adicionar novos modelos
    if (modelosPorProvedor[provedor]) {
        modelosPorProvedor[provedor].forEach(modelo => {
            const option = document.createElement('option');
            option.value = modelo.value;
            option.textContent = modelo.text;
            modeloSelect.appendChild(option);
        });
    }
    
    // Selecionar o modelo atual se existir
    const modeloAtual = '{{ especialista.modelo if especialista else "" }}';
    if (modeloAtual && modeloSelect.querySelector(`option[value="${modeloAtual}"]`)) {
        modeloSelect.value = modeloAtual;
    }
}

// Inicializar modelos no carregamento da página
document.addEventListener('DOMContentLoaded', function() {
    atualizarModelos();
    
    // Inicializar funcionalidades avançadas
    inicializarProcessamentoAvancado();
    
    // Carregar filtros específicos do especialista
    carregarFiltrosEspecializacao();
});

// Funcionalidades de Processamento Vetorial Avançado
function inicializarProcessamentoAvancado() {
    // Sliders do chunking inteligente
    const tamanhoChunk = document.getElementById('tamanhoChunk');
    const sensibilidadeEstrutura = document.getElementById('sensibilidadeEstrutura');
    
    if (tamanhoChunk) {
        tamanhoChunk.addEventListener('input', function() {
            document.getElementById('tamanhoChunkValue').textContent = this.value + ' palavras';
        });
    }
    
    if (sensibilidadeEstrutura) {
        sensibilidadeEstrutura.addEventListener('input', function() {
            document.getElementById('sensibilidadeValue').textContent = this.value + '/10';
        });
    }
    
    // Sliders de qualidade e relevância
    const pesoConceitos = document.getElementById('pesoConceitos');
    const densidadeInfo = document.getElementById('densidadeInfo');
    
    if (pesoConceitos) {
        pesoConceitos.addEventListener('input', function() {
            document.getElementById('pesoConceitosValue').textContent = this.value + '%';
        });
    }
    
    if (densidadeInfo) {
        densidadeInfo.addEventListener('input', function() {
            document.getElementById('densidadeValue').textContent = this.value + '/10';
        });
    }
    
    // Sliders de embeddings híbridos
    const pesoContexto = document.getElementById('pesoContexto');
    
    if (pesoContexto) {
        pesoContexto.addEventListener('input', function() {
            document.getElementById('pesoContextoValue').textContent = this.value + '%';
        });
    }
    
    // Validação dinâmica de configurações
    configurarValidacaoAvancada();
}

function configurarValidacaoAvancada() {
    // Validar consistência entre configurações
    const modoFragmentacao = document.querySelector('select[name="modo_fragmentacao_avancado"]');
    const scoreMinimo = document.querySelector('select[name="score_minimo_relevancia"]');
    
    if (modoFragmentacao) {
        modoFragmentacao.addEventListener('change', function() {
            const modo = this.value;
            mostrarDicasConfiguracao(modo);
        });
    }
    
    // Mostrar preview de configurações
    const botaoPreview = criarBotaoPreview();
    if (botaoPreview) {
        document.querySelector('#processamentoTabContent').appendChild(botaoPreview);
    }
}

function mostrarDicasConfiguracao(modo) {
    const dicasContainer = document.getElementById('dicasConfiguracao') || criarContainerDicas();
    
    const dicas = {
        'semantico': {
            titulo: 'Modo Semântico',
            descricao: 'Ideal para documentos com estrutura bem definida. Detecta automaticamente títulos, artigos e parágrafos.',
            recomendacoes: [
                'Sensibilidade à estrutura: 7-9',
                'Score mínimo de relevância: 3-4',
                'Tamanho ótimo: 250-300 palavras'
            ]
        },
        'hierarquico': {
            titulo: 'Modo Hierárquico',
            descricao: 'Foca na estrutura hierárquica do documento. Preserva relações entre seções.',
            recomendacoes: [
                'Sensibilidade à estrutura: 8-10',
                'Score mínimo de relevância: 2-3',
                'Ideal para códigos e leis'
            ]
        },
        'hibrido': {
            titulo: 'Modo Híbrido',
            descricao: 'Combina detecção semântica e hierárquica. Melhor precisão geral.',
            recomendacoes: [
                'Configuração balanceada recomendada',
                'Score mínimo de relevância: 3',
                'Melhor para documentos complexos'
            ]
        },
        'basico': {
            titulo: 'Modo Básico',
            descricao: 'Compatibilidade com sistema anterior. Fragmentação simples por tamanho.',
            recomendacoes: [
                'Use apenas se necessário',
                'Menor precisão semântica',
                'Compatível com processamento existente'
            ]
        }
    };
    
    const dica = dicas[modo] || dicas['semantico'];
    
    dicasContainer.innerHTML = `
        <div class="alert alert-info bg-dark border-info text-white">
            <h6 class="text-info">${dica.titulo}</h6>
            <p class="mb-2">${dica.descricao}</p>
            <ul class="mb-0">
                ${dica.recomendacoes.map(rec => `<li>${rec}</li>`).join('')}
            </ul>
        </div>
    `;
}

function criarContainerDicas() {
    const container = document.createElement('div');
    container.id = 'dicasConfiguracao';
    container.className = 'mt-3';
    
    const chunkingTab = document.getElementById('chunking');
    if (chunkingTab) {
        chunkingTab.appendChild(container);
    }
    
    return container;
}

function criarBotaoPreview() {
    const botao = document.createElement('button');
    botao.type = 'button';
    botao.className = 'btn btn-outline-success btn-sm mt-3';
    botao.innerHTML = '<i class="fas fa-eye me-1"></i>Preview das Configurações';
    botao.onclick = mostrarPreviewConfiguracoes;
    
    return botao;
}

function mostrarPreviewConfiguracoes() {
    const config = obterConfiguracoesAtuais();
    
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'previewModal';
    modal.innerHTML = `
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-success">Preview das Configurações Avançadas</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-info">Chunking Inteligente</h6>
                            <ul class="list-unstyled">
                                <li><strong>Modo:</strong> ${config.modo_fragmentacao}</li>
                                <li><strong>Tamanho:</strong> ${config.tamanho_chunk} palavras</li>
                                <li><strong>Sensibilidade:</strong> ${config.sensibilidade}/10</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-info">Qualidade</h6>
                            <ul class="list-unstyled">
                                <li><strong>Score mínimo:</strong> ${config.score_minimo}/5</li>
                                <li><strong>Peso conceitos:</strong> ${config.peso_conceitos}%</li>
                                <li><strong>Densidade:</strong> ${config.densidade}/10</li>
                            </ul>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6 class="text-info">Auto Fine-Tuning</h6>
                            <ul class="list-unstyled">
                                <li><strong>Perguntas por chunk:</strong> ${config.perguntas_por_chunk}</li>
                                <li><strong>Tipos ativos:</strong> ${config.tipos_perguntas}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-info">Embeddings</h6>
                            <ul class="list-unstyled">
                                <li><strong>Modelo:</strong> ${config.modelo_embedding}</li>
                                <li><strong>Peso contexto:</strong> ${config.peso_contexto}%</li>
                                <li><strong>Cache:</strong> ${config.cache_ativo ? 'Ativo' : 'Inativo'}</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="alert alert-success bg-dark border-success">
                            <h6 class="text-success">Estimativa de Performance</h6>
                            <p class="mb-1"><strong>Qualidade esperada:</strong> ${calcularQualidadeEsperada(config)}</p>
                            <p class="mb-1"><strong>Velocidade:</strong> ${calcularVelocidadeEsperada(config)}</p>
                            <p class="mb-0"><strong>Precisão semântica:</strong> ${calcularPrecisaoEsperada(config)}</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" onclick="salvarConfiguracoesOtimizadas()">Aplicar Otimizações</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    // Remover modal quando fechado
    modal.addEventListener('hidden.bs.modal', () => modal.remove());
}

function obterConfiguracoesAtuais() {
    return {
        modo_fragmentacao: document.querySelector('select[name="modo_fragmentacao_avancado"]')?.value || 'semantico',
        tamanho_chunk: document.getElementById('tamanhoChunk')?.value || '275',
        sensibilidade: document.getElementById('sensibilidadeEstrutura')?.value || '7',
        score_minimo: document.querySelector('select[name="score_minimo_relevancia"]')?.value || '3',
        peso_conceitos: document.getElementById('pesoConceitos')?.value || '70',
        densidade: document.getElementById('densidadeInfo')?.value || '6',
        perguntas_por_chunk: document.querySelector('select[name="perguntas_por_chunk"]')?.value || '4',
        tipos_perguntas: contarTiposPerguntas(),
        modelo_embedding: document.querySelector('select[name="modelo_embedding"]')?.value || 'text-embedding-3-small',
        peso_contexto: document.getElementById('pesoContexto')?.value || '25',
        cache_ativo: document.querySelector('input[name="cache_embeddings"]')?.checked || false
    };
}

function contarTiposPerguntas() {
    const tipos = ['basicas', 'intermediarias', 'avancadas', 'especializadas'];
    const ativos = tipos.filter(tipo => 
        document.querySelector(`input[name="gerar_perguntas_${tipo}"]`)?.checked
    );
    return ativos.length;
}

function calcularQualidadeEsperada(config) {
    let score = 60; // Base
    
    // Modo de fragmentação
    const bonusModo = { 'semantico': 15, 'hierarquico': 12, 'hibrido': 20, 'basico': 0 };
    score += bonusModo[config.modo_fragmentacao] || 0;
    
    // Score mínimo
    score += parseInt(config.score_minimo) * 3;
    
    // Modelo de embedding
    if (config.modelo_embedding.includes('large')) score += 10;
    if (config.modelo_embedding.includes('3')) score += 5;
    
    return Math.min(100, score) + '%';
}

function calcularVelocidadeEsperada(config) {
    let score = 70; // Base
    
    // Tamanho do chunk
    const tamanho = parseInt(config.tamanho_chunk);
    if (tamanho < 250) score += 10;
    if (tamanho > 350) score -= 10;
    
    // Cache
    if (config.cache_ativo) score += 15;
    
    // Modelo
    if (config.modelo_embedding.includes('small')) score += 10;
    if (config.modelo_embedding.includes('large')) score -= 10;
    
    return Math.min(100, Math.max(30, score)) + '%';
}

function calcularPrecisaoEsperada(config) {
    let score = 65; // Base
    
    // Sensibilidade à estrutura
    score += parseInt(config.sensibilidade) * 2;
    
    // Peso dos conceitos
    if (parseInt(config.peso_conceitos) > 60) score += 10;
    
    // Tipos de perguntas
    score += config.tipos_perguntas * 3;
    
    return Math.min(100, score) + '%';
}

function salvarConfiguracoesOtimizadas() {
    // Aplicar otimizações baseadas na análise
    const config = obterConfiguracoesAtuais();
    
    // Otimizações automáticas
    if (config.modo_fragmentacao === 'semantico') {
        // Ajustar sensibilidade para ótimo
        const sensibilidadeSlider = document.getElementById('sensibilidadeEstrutura');
        if (sensibilidadeSlider && parseInt(sensibilidadeSlider.value) < 7) {
            sensibilidadeSlider.value = '8';
            sensibilidadeSlider.dispatchEvent(new Event('input'));
        }
    }
    
    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('previewModal'));
    modal.hide();
    
    // Mostrar confirmação
    mostrarNotificacao('Configurações otimizadas aplicadas!', 'success');
}

function mostrarNotificacao(mensagem, tipo = 'info') {
    const notificacao = document.createElement('div');
    notificacao.className = `alert alert-${tipo} alert-dismissible fade show position-fixed`;
    notificacao.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notificacao.innerHTML = `
        ${mensagem}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notificacao);
    
    // Auto-remover após 5 segundos
    setTimeout(() => {
        if (notificacao.parentNode) {
            notificacao.remove();
        }
    }, 5000);
}

// Sistema de Filtros Personalizados por Área
function carregarFiltrosEspecializacao() {
    const especialistaId = '{{ especialista.id if especialista else "" }}';
    const filtrosSelect = document.getElementById('filtrosEspecializacao');
    const statusFiltros = document.getElementById('statusFiltros');
    
    if (!especialistaId || !filtrosSelect) {
        carregarFiltrosPadrao();
        return;
    }
    
    statusFiltros.textContent = 'Carregando filtros específicos...';
    statusFiltros.className = 'text-warning ms-2';
    
    fetch(`/especialistas/api/filtros-especializacao/${especialistaId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                aplicarFiltrosEspecializacao(data);
                statusFiltros.textContent = `Filtros de ${data.area_principal} carregados`;
                statusFiltros.className = 'text-success ms-2';
            } else {
                throw new Error(data.error || 'Erro ao carregar filtros');
            }
        })
        .catch(error => {
            console.error('Erro ao carregar filtros:', error);
            statusFiltros.textContent = 'Erro ao carregar filtros - usando padrão';
            statusFiltros.className = 'text-danger ms-2';
            carregarFiltrosPadrao();
        });
}

function aplicarFiltrosEspecializacao(data) {
    const filtrosSelect = document.getElementById('filtrosEspecializacao');
    
    filtrosSelect.innerHTML = '';
    
    data.filtros.forEach(filtro => {
        const option = document.createElement('option');
        option.value = filtro.value;
        option.textContent = filtro.label;
        
        if (data.filtros_selecionados.includes(filtro.value)) {
            option.selected = true;
        }
        
        filtrosSelect.appendChild(option);
    });
    
    filtrosSelect.style.borderColor = '#28a745';
    setTimeout(() => {
        filtrosSelect.style.borderColor = '';
    }, 2000);
}

function carregarFiltrosPadrao() {
    const filtrosSelect = document.getElementById('filtrosEspecializacao');
    
    const filtrosPadrao = [
        { value: 'direito_agrario_geral', label: 'Direito Agrário Geral' },
        { value: 'contratos_rurais_geral', label: 'Contratos Rurais' },
        { value: 'propriedade_rural_geral', label: 'Propriedade Rural' },
        { value: 'legislacao_agraria', label: 'Legislação Agrária' },
        { value: 'documentos_juridicos', label: 'Documentos Jurídicos' }
    ];
    
    filtrosSelect.innerHTML = '';
    
    filtrosPadrao.forEach((filtro, index) => {
        const option = document.createElement('option');
        option.value = filtro.value;
        option.textContent = filtro.label;
        
        if (index < 3) {
            option.selected = true;
        }
        
        filtrosSelect.appendChild(option);
    });
}

function detectarMudancaArea() {
    const areaSelect = document.getElementById('areaEspecialidadeSelect');
    if (areaSelect) {
        areaSelect.addEventListener('change', function() {
            carregarFiltrosPorArea(this.value);
        });
    }
}

function carregarFiltrosPorArea(area) {
    const statusFiltros = document.getElementById('statusFiltros');
    statusFiltros.textContent = 'Atualizando filtros para nova área...';
    statusFiltros.className = 'text-warning ms-2';
    
    fetch('/especialistas/api/filtros-por-area')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.filtros_por_area[area]) {
                const filtrosArea = data.filtros_por_area[area];
                aplicarFiltrosArea(filtrosArea, area);
                statusFiltros.textContent = `Filtros de ${area} atualizados`;
                statusFiltros.className = 'text-success ms-2';
            } else {
                carregarFiltrosPadrao();
                statusFiltros.textContent = 'Usando filtros padrão';
                statusFiltros.className = 'text-info ms-2';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar filtros por área:', error);
            carregarFiltrosPadrao();
            statusFiltros.textContent = 'Erro - usando filtros padrão';
            statusFiltros.className = 'text-danger ms-2';
        });
}

function aplicarFiltrosArea(filtros, area) {
    const filtrosSelect = document.getElementById('filtrosEspecializacao');
    
    filtrosSelect.innerHTML = '';
    
    filtros.forEach((filtro, index) => {
        const option = document.createElement('option');
        option.value = filtro.value;
        option.textContent = filtro.label;
        
        if (index < 3) {
            option.selected = true;
        }
        
        filtrosSelect.appendChild(option);
    });
    
    filtrosSelect.style.borderColor = '#17a2b8';
    setTimeout(() => {
        filtrosSelect.style.borderColor = '';
    }, 2000);
}

function obterFiltrosSelecionados() {
    const filtrosSelect = document.getElementById('filtrosEspecializacao');
    const opcoesSelecionadas = Array.from(filtrosSelect.selectedOptions);
    return opcoesSelecionadas.map(option => ({
        value: option.value,
        label: option.textContent
    }));
}

function validarFiltros() {
    const filtrosSelecionados = obterFiltrosSelecionados();
    
    if (filtrosSelecionados.length === 0) {
        mostrarNotificacao('Selecione pelo menos um filtro de especialização', 'warning');
        return false;
    }
    
    if (filtrosSelecionados.length > 7) {
        mostrarNotificacao('Selecione no máximo 7 filtros para manter a precisão', 'warning');
        return false;
    }
    
    return true;
}

// Inicializar sistema de filtros personalizados no carregamento
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        detectarMudancaArea();
        
        const form = document.querySelector('form');
        if (form) {
            form.addEventListener('submit', function(e) {
                if (!validarFiltros()) {
                    e.preventDefault();
                    return false;
                }
            });
        }
    }, 1000);
});

console.log('Sistema de filtros personalizados por área carregado');
</script>
{% endblock %}